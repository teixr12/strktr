# Phase 2 Closeout Report

- GeneratedAt: 2026-02-28T15:20:51Z
- Stage: baseline-before-table-virtualization
- Version: 2cf2b83b43e9b4503922505996f1837d594791b9
- Flags: uiPaginationV1=true, analyticsExternalV1=true, tableVirtualization=false

## Route Latency Sample (25 requests, client-side total_time)
- /dashboard: min=0.337329s p50=0.359177s p95=0.584247s max=0.745448s
- /leads: min=0.322791s p50=0.336732s p95=0.381353s max=0.415727s
- /financeiro: min=0.321021s p50=0.334974s p95=0.393476s max=0.445620s
- /api/v1/health/ops: min=0.316522s p50=0.392545s p95=0.448787s max=0.456729s

## Health Snapshot
```json
{"data":{"status":"ok","ts":"2026-02-28T15:20:51.853Z","checks":[{"name":"runtime","ok":true},{"name":"supabase_connection","ok":true}],"version":"2cf2b83b43e9b4503922505996f1837d594791b9","flags":{"uiTailadminV1":true,"uiV2Obras":true,"uiV2Leads":true,"uiV2Dashboard":true,"uiV2Financeiro":true,"uiV2Comercial":true,"uiV2Compras":true,"uiV2Projetos":true,"uiV2Orcamentos":true,"uiV2Equipe":true,"uiV2Agenda":true,"uiV2Knowledgebase":true,"uiV2Configuracoes":true,"uiV2Perfil":true,"uiV2ObraTabs":true,"profileAvatarV2":true,"navCountsV2":true,"leadsProgressV2":true,"orcamentoPdfV2":true,"uiPaginationV1":true,"tableVirtualization":false,"checklistDueDate":true,"productAnalytics":true,"analyticsExternalV1":true,"cronogramaEngine":true,"cronogramaPdf":true,"clientPortal":true,"approvalGate":true,"architectAgenda":true,"personalRoadmap":true,"semiAutomation":true,"behaviorPrompts":true}},"meta":{"contractVersion":"v1"},"requestId":"dd602c5f-195e-451c-b035-342512ecd39c"}
```

## Canary-on Snapshot

- GeneratedAt: 2026-02-28T15:36:15Z
- Stage: canary-table-virtualization-on
- Version: 2cf2b83b43e9b4503922505996f1837d594791b9
- Flags: uiPaginationV1=true, analyticsExternalV1=true, tableVirtualization=true

### Route Latency Sample (25 requests, client-side total_time)
- /dashboard: min=0.343976s p50=0.363221s p95=0.937917s max=1.127438s
- /leads: min=0.314009s p50=0.325173s p95=0.347487s max=0.360805s
- /financeiro: min=0.315338s p50=0.333256s p95=0.472406s max=0.519556s
- /api/v1/health/ops: min=0.312776s p50=0.351386s p95=0.398208s max=0.402807s

### Health Snapshot
```json
{"data":{"status":"ok","ts":"2026-02-28T15:36:15.620Z","checks":[{"name":"runtime","ok":true},{"name":"supabase_connection","ok":true}],"version":"2cf2b83b43e9b4503922505996f1837d594791b9","flags":{"uiTailadminV1":true,"uiV2Obras":true,"uiV2Leads":true,"uiV2Dashboard":true,"uiV2Financeiro":true,"uiV2Comercial":true,"uiV2Compras":true,"uiV2Projetos":true,"uiV2Orcamentos":true,"uiV2Equipe":true,"uiV2Agenda":true,"uiV2Knowledgebase":true,"uiV2Configuracoes":true,"uiV2Perfil":true,"uiV2ObraTabs":true,"profileAvatarV2":true,"navCountsV2":true,"leadsProgressV2":true,"orcamentoPdfV2":true,"uiPaginationV1":true,"tableVirtualization":true,"checklistDueDate":true,"productAnalytics":true,"analyticsExternalV1":true,"cronogramaEngine":true,"cronogramaPdf":true,"clientPortal":true,"approvalGate":true,"architectAgenda":true,"personalRoadmap":true,"semiAutomation":true,"behaviorPrompts":true}},"meta":{"contractVersion":"v1"},"requestId":"0388fada-bef3-4374-a867-a6caafdcc8ba"}
```

## Rollback Drill (real)

- Drill start: 2026-02-28T15:36:59Z
- Fallback validated (`tableVirtualization=false`): 2026-02-28T15:38:51Z
- Restore start (`tableVirtualization=true`): 2026-02-28T15:39:30Z
- Restore validated (`tableVirtualization=true`): 2026-02-28T15:41:01Z

### TTR
- TTR to fallback (`true -> false`): 1m52s
- TTR to restore (`false -> true`): 1m31s

## Canary Smoke

- `/dashboard`: 200
- `/leads`: 200
- `/financeiro`: 200
- `/api/v1/health/ops`: 200

## Operational Notes

- Root cause found during canary: `NEXT_PUBLIC_FF_TABLE_VIRTUALIZATION` and `NEXT_PUBLIC_FF_UI_PAGINATION_V1` were previously stored with trailing newline in Vercel env.
- Fix applied: both vars were removed and re-added as clean values (`true` without newline), followed by redeploy.
- Result: `health/ops` now reflects flags correctly and rollback drill is deterministic.
- Playwright smoke against production URL from this sandbox remained blocked by DNS/browser sandbox constraints (`ENOTFOUND` / Chromium launch permission). HTTP smoke and health checks were used as primary runtime validation in this execution context.

## Analytics Drift (D0 kick-off)

- Drift report file: `docs/reports/analytics-drift-20260228-124508.md`
- Result: `warn`
- `MaxAbsDriftPct`: `100`
- Main gaps:
  - `PageViewed`: internal `69` vs external `47` (`-31.88%`)
  - `portal_approval_decision`: internal `39` vs external `0` (`-100%`)

### Next operational action
- Keep `analyticsExternalV1=true` and collect 7 daily reports with:
  - `npm run audit:analytics-drift`
- Investigate mapping/ingest for `portal_approval_decision` if gap persists in D1/D2.

## Post-D0 Hotfix (portal approval external mirror)

- Merge commit: `c1c817afc72acaab590074fcf975b38c3036bdb6`
- ADR: `docs/adr/0018-server-side-posthog-mirror-for-portal-approval.md`
- Scope:
  - Added optional PostHog server mirror in telemetry emitter (fail-safe).
  - Enabled mirror only for:
    - `POST /api/v1/portal/aprovacoes/[id]/approve`
    - `POST /api/v1/portal/aprovacoes/[id]/reject`
- Safety:
  - Internal analytics remains source of truth.
  - No API contract changes in `/api/v1`.
  - External mirror is best-effort and non-blocking.

### Production confirmation

- `health/ops.status=ok`
- `health/ops.version=c1c817afc72acaab590074fcf975b38c3036bdb6`
- Flags:
  - `analyticsExternalV1=true`
  - `uiPaginationV1=true`
  - `tableVirtualization=true`
