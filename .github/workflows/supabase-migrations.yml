name: Supabase Migrations

on:
  workflow_dispatch:
    inputs:
      target_environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging
      stage:
        description: "Migration stage (expand -> backfill -> switch -> cleanup)"
        required: true
        type: choice
        options:
          - expand
          - backfill
          - switch
          - cleanup
      migration_file:
        description: "Path to migration SQL (ex: supabase/migrations/20260225_product_events.sql)"
        required: true
        type: string
      run_audits:
        description: "Run pre/post tenancy and schema audits"
        required: true
        type: boolean
        default: true
      dry_run:
        description: "Validate and preview only (no DB write)"
        required: true
        type: boolean
        default: true

permissions:
  contents: read

concurrency:
  group: supabase-migration-${{ inputs.target_environment }}
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate migration input
        run: |
          FILE="${{ inputs.migration_file }}"
          STAGE="${{ inputs.stage }}"

          if [[ ! "$FILE" =~ ^supabase/migrations/.+\.sql$ ]]; then
            echo "migration_file must be inside supabase/migrations and end with .sql" >&2
            exit 1
          fi

          if [[ ! -f "$FILE" ]]; then
            echo "Migration file not found: $FILE" >&2
            exit 1
          fi

          if ! grep -Eiq "(^|[^a-z])${STAGE}([^a-z]|$)" "$FILE"; then
            echo "Warning: stage '${STAGE}' not found in file content. Proceed with caution."
          fi

          if grep -Eiq "drop[[:space:]]+table|drop[[:space:]]+column" "$FILE"; then
            echo "Destructive operation detected. Use a dedicated reviewed migration for destructive cleanup." >&2
            exit 1
          fi

      - name: Show migration preview
        run: |
          echo "Previewing first 120 lines of ${{ inputs.migration_file }}"
          sed -n '1,120p' "${{ inputs.migration_file }}"

      - name: Dry-run summary
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "Dry-run mode enabled. No migration will be applied."

  apply:
    needs: validate
    if: ${{ inputs.dry_run == false }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.target_environment == 'production' && 'supabase-production' || 'supabase-staging' }}
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      MIGRATION_FILE: ${{ inputs.migration_file }}
      RUN_AUDITS: ${{ inputs.run_audits }}
      STAGE: ${{ inputs.stage }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [[ -z "${SUPABASE_ACCESS_TOKEN}" || -z "${SUPABASE_PROJECT_REF}" ]]; then
            echo "Missing SUPABASE_ACCESS_TOKEN or SUPABASE_PROJECT_REF in repository/environment secrets." >&2
            exit 1
          fi

      - name: Pre-migration audits
        if: ${{ env.RUN_AUDITS == 'true' }}
        run: |
          bash scripts/supabase-query-ci.sh supabase/sql/audit_migrations_applied.sql
          bash scripts/supabase-query-ci.sh supabase/sql/audit_tenancy_rls_status.sql
          bash scripts/supabase-query-ci.sh supabase/sql/audit_org_id_nulls.sql

      - name: Apply migration
        run: |
          echo "Applying stage '${STAGE}' migration: ${MIGRATION_FILE}"
          bash scripts/supabase-query-ci.sh "${MIGRATION_FILE}"

      - name: Post-migration audits
        if: ${{ env.RUN_AUDITS == 'true' }}
        run: |
          bash scripts/supabase-query-ci.sh supabase/sql/audit_migrations_applied.sql
          bash scripts/supabase-query-ci.sh supabase/sql/audit_tenancy_rls_status.sql
          bash scripts/supabase-query-ci.sh supabase/sql/audit_org_id_nulls.sql
